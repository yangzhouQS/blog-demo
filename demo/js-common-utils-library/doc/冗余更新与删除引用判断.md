# impala增加模块
```
需要使用的包：@mctech/dp-impala-enhanced
服务：dp-enhanced-metadata-service
```
## 冗余字段更新

### 冗余关系描述方式

存储在dms数据库中表redundancy和redundancy_col中配置冗余更新配置
示例：
```
INSERT INTO `redundancy` VALUES (106, 'platform', 'company', 'mtlp', 'c_supplier', 'id=id', 1);

INSERT INTO `redundancy_col` VALUES (10601, 106, 'name', 'supplier_name', 1, NULL);
INSERT INTO `redundancy_col` VALUES (10602, 106, 'short_name', 'supplier_abb_name', 1, NULL);
```
### 实现方式

1. 基于impala事务功能，利用了`committed`事件通知实现
2. 提供api，主动发送通知。这种方式无需开启事务，但是也无法方便的做到只修改冗余字段时才发送通知，除非调用者知道哪些字段被冗余了

### 配置文件

已在公共配置文件 application-{dev|project}.yml中配置，无需在每个服务中单独配置

```yaml

redundancy:
  mq:
    type: 'ons'
    ons:
      accessKey: ''
      secretKey: ''
      producerId: ''
      scope: ''
```

### 使用方式

1. 隐式发送变化通知

只有在开启了impala事务里，才能生效

依赖于 `@mctech/infra-impala-transaction` 模块 4.1.1以上版本

```javascript
const $appServer = require('@mctech/infra-cloud').appServer()

require('@mctech/dp-impala-enhanced')

const startPromise = $appServer.start()
```

2. 显示通知

代码里主动调用数据变更通知的api，一般用于没有开启事务，修改的记录的主键确定的情况。用到的api如下：

```javascript
namespace redundancy {
  interface NotifyOption {
    /**
     * 源数据库的全名称，例如gslq4dev_ipm
     */
    fullDbName: string
    /**
     * 源数据库的短名称，例如ipm
     */
    shortDbName: string
    /**
     * 存在变化数据的表名称，例如entry_work
     */
    tableName: string
    /**
     * 存在变化记录信息
     */
    data: {
      /**
       * 主键字段列表。例如 ['id'] 或 ['id', 'org_id']
       */
      keys: string[]
      /**
       * 与keys值对应的主键值的列表。
       * 如果是单主键，使用一维数组；如果是多主键，使用二维数组，
       */
      records: any[] | any[][]
      /**
       * 变更的列，如果为null(undefined) 或 []，表示变更的列无法确定
       */
      refs: string[]
    }
  }

  /**
   * 调用者主动发变更通知
   * @param option
   */
  async function notify(option: Notification): Promise<void>
}
```

3. 示例代码

```javascript
const { redundancy } = require('@mctech/dp-impala-enhanced')

// 上下文中必须能获取到租户id

......
await redundancy.notify({
  fullDbName: 'gslq4dev_ipm',
  shortDbName: 'ipm',
  tableName: 'entry_work',
  data: {
    keys: ['id', 'org_id'],
    refs: ['name'],
    /**
     * 与keys值对应的主键值的列表。
     * 如果是单主键，使用一维数组；如果是多主键，使用二维数组，
     */
    records: [[443315208933376, 9527], [447422110806016,9527],......]
  }
})
```

## 删除时检查引用关系

### 冗余关系描述方式

存储在dms数据库中，通过dp-enhanced-metadata-service服务获取
示例：
```
INSERT INTO `constraint_info` VALUES (113, 'platform', 'company', 'mtlp', 'c_supplier', '', '', 'soft', 'id=id', '当前数据被常用供应商模块引用', 0, '供应商删除测试');
```
### 实现方式

1. 基于impala事务功能，利用了`modified`事件通知实现
2. 提供api，主动检查约束信息。这种方式无需开启事务

## 支持的删除方式

既支持执行delete语句的真删除，也支持通过设置`is_removed`字段值为true的假删除

需要在配置约束检查的表里设置，待检查约束关系的目标表的删除方式是真删除('hard')还是假删除('soft')

1. 通过api调用

```javascript
export namespace constraint {
  interface ConstraintCheckOption {
    /**
     * 租户code
     */
    tenantCode: string
    /**
     * 删除操作所在的据库的短名称，例如'ipm'
     */
    shortDbName: string
    /**
     * 删除操作所在的表
     */
    tableName
    /**
     * 要删除记录信息
     */
    data: {
      /**
       * 主键字段列表。例如 ['id'] 或 ['id', 'org_id']
       */
      keys: string[]
      /**
       * 与keys值对应的主键值的列表。
       * 如果是单主键，使用一维数组；如果是多主键，使用二维数组，
       */
      records: any[] | any[][]
    }
  }

  export type ParameterObject = { [name: string]: any }

  export interface CheckResult {
    /**
     * 租户code
     */
    tenantCode: string
    /**
     * 引用关系的目标数据库短名称
     */
    shortDbName: string
    /**
     * 引用关系的目标表名
     */
    tableName: string
    /**
     * 引用关系的目标模块编码
     */
    moduleCode: string
    /**
     * 引用关系的目标模块显示名称
     */
    moduleName: string
    /**
     * 约束提示信息模板
     */
    template: string
    /**
     * 根据模板提取的参数返回的目标表的记录的部分字段信息。
     * 数据组中每一项表示一第引用记录的信息，其中每个个属性对应着模板中的一个参数
     * 如果当前对象不为null，则data的值至少1项，最多返回10项
     */
    data: ParameterObject[]
  }

  /**
   * 执行约束检查，如果存在约束引用则返回第一个匹配到的引用信息
   * @param option
   */
  export function check(option: ConstraintCheckOption): Promise<any>

  /**
   * 填充模板参数，格式化提示信息模板字符串
   *
   * @param template 含参数的模板
   * @param params 参数json对象，属性名称即参数名称
   *
   * @returns {string}
   */
  export function formatTemplate(template: string, params?: ParameterObject): string
}
```
### 使用方式

1. 隐式检查

只有在开启了impala事务里，才能生效。利用的是impala事务中的事件通知机制，开发人员只需要添加包的引用，不需其它要任何操作

2. 使用api方式

```javascript
const { constraint } = require('@mctech/dp-impala-enhanced')

const result = await constraint.check({
  tenantCode: 'gslq4dev',
  shortDbName: 'ipm',
  tableName: 'entry_work',
  data: {
    keys: ['org_id', 'id'],
    records: [[433256028794880, 444572020551680]]
  }
})

// 存在被引用的数据
if(result) {
  // 使用第一条被引用的数据生成格式化信息
  const str = constraint.formatTemplate(result.template, result.data[0])
  console.log(str)
}

```

* `formatTemplate` 方法可以使用返回结果中的某一条数据生成格式化后的提示字符串。假如`result.template`值为'当前数据被[{project_unit_work_code}]的数据引用', 返回的result.data[0]的值为 `{"project_unit_work_code": "code_0001"}`，格式化后的字符串为'当前数据为[code_0001]的数据引用'

## 主动初始化

如果impala的配置不是使用的`@mctech/dp-impala`模块的标准配置格式，必须调用init方法指定配置信息

```javascript

const { init } = require('@mctech/dp-impala-enhanced')

init({
  host: '192.168.1.128',
  port: 21050,
  impersonationEnabled: true,
  security: {
    user: 'hue',
    ldapPassword: '123321',
    useLdap: true
  }
})

```