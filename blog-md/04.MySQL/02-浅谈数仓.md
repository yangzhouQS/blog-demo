# 浅谈数仓一、数仓概念和数仓建设

数据仓库概念由比尔.恩门于1990年提出，主要是将OLTP系统存储的数据，经数据仓库特有的理论以及架构体系，进行系统的分析整理。

### 数仓目的

构建面向分析的集成化数据环境，为企业提提决策支持。

### 数仓的作用

- 提供集成的结构化数据
- 解决从数据库中获取信息的问题

### 数仓的特点

数仓的特点是面向主题的，集成的，稳定的，反向历史变化的。

### 数仓知识点

数仓作为数据的搬运工，本身不产生数据，也不消费数据，数据来源于外部，也开放给外部系统。
随着大数据系统的发展，机器学习以及人工智能的崛起，数仓已经不仅仅作为为企业提供决策支持的商业智能BI，也是大量机器学习以及人工智能算法的底层支持。

### 数仓特点详解

#### 面向主题的 Subject Oriented

数据仓库是⽤来分析特定主题域的，所以说数据仓库是⾯向主题的。

电商业务主题域：

- 交易域
- 商品域
- 用户域
- 财务域

社交业务：

- 内容域
- 会员域
- 互动域
- 交易域

#### 集成的 Integrated

数据仓库集成了多个数据源，同⼀主题或产品相关数据可能来⾃不同系统不同类型的数据库、⽇志⽂件等。

#### 稳定的 Non-Volatile

数据⼀旦进⼊数据仓库，则不可改变。数据仓库的历史数据是不应该被更新 的，同时存储的稳定性较强。

#### 反映历史变化的 Time Variant

数据仓库保存了⻓期的历史数据，这点是相对OLTP的数据库⽽⾔。因为性能考虑后者通常保存近期的热数据。

### 数据仓库核心组件

数据仓库的核心组件有四个：源数据库，ETL，数据仓库，业务应用。

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606193259.png)](https://static.studytime.xin/article/20200606193259.png)

#### 业务系统

业务系统包含各种源数据库，这些源数据库既为业务系统提供数据支撑，同时也作为数据仓库的数据源(注：除了业务系统，数据仓库也可从其他外部数据源获取数据)

#### ETL

ETL分别代表：提取extraction、转换transformation、加载load。其中提取过程表示操作型数据库搜集指定数据，转换过程表示将数据转化为指定格式并进行数据清洗保证数据质量，加载过程表示将转换过后满足指定格式的数据加载进数据仓库。数据仓库会周期不断地从源数据库提取清洗好了的数据，因此也被称为”目标系统”

#### 业务应用

和操作型数据库一样，数据仓库通常提供具有直接访问数据仓库功能的业务应用，这些应用也被称为BI(商务智能)应用

### ETL详解

ETL工作的实质就是从各个数据源提取数据，对数据进行转换，并最终加载填充数据到数据仓库维度建模后的表中。只有当这些维度/事实表被填充好，ETL工作才算完成。接下来分别对抽取，转换，加载这三个环节进行讲解：

#### 抽取(Extract)

数据仓库是面向分析的，而操作型数据库是面向应用的。显然，并不是所有用于支撑业务系统的数据都有拿来分析的必要。因此，该阶段主要是根据数据仓库主题、主题域确定需要从应用数据库中提取的数。

具体开发过程中，开发人员必然经常发现某些ETL步骤和数据仓库建模后的表描述不符。这时候就要重新核对、设计需求，重新进行ETL。正如数据库系列的这篇中讲到的，任何涉及到需求的变动，都需要重头开始并更新需求文档。

#### 转换(Transform)

转换步骤主要是指对提取好了的数据的结构进行转换，以满足目标数据仓库模型的过程。此外，转换过程也负责数据质量工作，这部分也被称为数据清洗(data cleaning)。数据质量涵盖的内容可具体参考这里。

#### 加载(Load)

加载过程将已经提取好了，转换后保证了数据质量的数据加载到目标数据仓库。加载可分为两种L：首次加载(first load)和刷新加载(refresh load)。其中，首次加载会涉及到大量数据，而刷新加载则属于一种微批量式的加载。

多说一句，如今随着各种分布式、云计算工具的兴起，ETL实则变成了ELT。就是业务系统自身不会做转换工作，而是在简单的清洗后将数据导入分布式平台，让平台统一进行清洗转换等工作。这样做能充分利用平台的分布式特性，同时使业务系统更专注于业务本身。

### 数据集市(data mart)

数据集市可以理解为是一种”小型数据仓库”，它只包含单个主题，且关注范围也非全局。

数据集市可以分为两种，一种是独立数据集市(independent data mart)，这类数据集市有自己的源数据库和ETL架构；另一种是非独立数据集市(dependent data mart)，这种数据集市没有自己的源系统，它的数据来自数据仓库。当用户或者应用程序不需要/不必要/不允许用到整个数据仓库的数据时，非独立数据集市就可以简单为用户提供一个数据仓库的”子集”。

### 数据湖概念

### 数据仓库开发流程

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606193410.png)](https://static.studytime.xin/article/20200606193410.png)
上图可以看出数据仓库开发最为耗时部分在ETL工程部分。因为该环节要整理各大业务系统中杂乱无章的数据并协调元数据上的差别，所以工作量很大。在很多公司都专门设有ETL工程师这样的岗位，大的公司甚至专门聘请ETL专家。

### 小结

在大数据时代，数据仓库的重要性更胜以往。Hadoop平台下的Hive，Spark平台下的Spark SQL都是各自生态圈内应用最热门的配套工具，而它们的本质就是开源分布式数据仓库。

在国内最优秀的互联网公司里(如阿里、腾讯)，很多数据引擎是架构在数据仓库之上的(如数据分析引擎、数据挖掘引擎、推荐引擎、可视化引擎等等)。不少员工认为，开发成本应更多集中在数据仓库层，不断加大数据建设的投入。因为一旦规范、标准、高性能的数据仓库建立好了，在之上进行数据分析、数据挖掘、跑推荐算法等都是轻松惬意的事情。反之如果业务数据没梳理好，各种脏乱数据会搞得人焦头烂额，苦不堪言。

### 参考文章

[数据仓库与数据集市建模](https://www.cnblogs.com/muchen/p/5310732.html)



# 浅谈数仓二、OLAP和DataCube数据魔方

OLTP( On-Line Transaction Processing ) 联机事务处理过程，通常也可以成为面向交易的处理系统。个人理解为主要场景针对用户人机交互频繁，数据量小，操作快速响应的实时处理系统中。Mysql以及Oracle等数据库软件可以理解为OLTP的工业应用软件体现。

OLAP( On-Line Analytical Processing)，联机分析处理过程。个人理解为主要场景针对大批量数据，实时性无要求，基于数仓多维模型，进行分析操作的系统中。Hadoop体系中MapReduce、Hive、Spark、Flink等都可以进行为OLAP实现。

### OLAP和OLTP区别

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200607010742.png)](https://static.studytime.xin/article/20200607010742.png)

### OLAP的特点

- 从用户的思考⻆度出发，仿照用户思考模式预先为构建多维的数据模型。
- 用户可以快速查询分析各个维度数据
- 能动态的在各个维度之间切换或者进行多维度综合分析，具有极大的分析灵活性。

### OLAP和数仓的关系

OLAP和数仓的关系是互补的。
一般以数据仓库作为基础，即从数据仓库中抽取详细数据的一个子集并经过必要的聚集存储到OLAP存储中供数据分析工具读取。

在规范化数据仓库中OLAP工具和数据仓库的关系大致是这样的：

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606193107.png)](https://static.studytime.xin/article/20200606193107.png)

这种情况下，OLAP不允许访问中心数据库。一方面中心数据库是采取规范化建模的，而OLAP只支持对维度建模数据的分析；另一方面规范化数据仓库的中心数据库本身就不允许上层开发人员访问。而在维度建模数据仓库中，OLAP/BI工具和数据仓库的关系则是这样的：
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606193144.png)](https://static.studytime.xin/article/20200606193144.png)

在维度建模数据仓库中，OLAP不但可以从数据仓库中直接取数进行分析，还能对架构在其上的数据集市群做同样工作。

### DataCube数据魔方

很多年前，当我们要手工从一堆数据中提取信息时，我们会分析一堆数据报告。通常这些数据报告采用二维表示，是行与列组成的二维表格。
但在真实世界里我们分析数据的角度很可能有多个，数据立方体可以理解为就是维度扩展后的二维表格。
下图展示了一个多维数据抽象的数据立方体：
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606191204.png)](https://static.studytime.xin/article/20200606191204.png)

尽管这个例子是三维的，但更多时候数据立方体是N维的。对于大多数纯OLAP使用者来讲，数据分析的对象就是这个逻辑概念上的数据立方体，其具体实现不用深究。对于这些OLAP工具的使用者来讲，基本用法是首先配置好维表、事实表，然后在每次查询的时候告诉OLAP需要展示的维度和事实字段和操作类型即可。

下面介绍数据魔方中(OLAP基本操作)最常见的五大操作：

- 切片
- 切块
- 旋转
- 上卷
- 钻取

#### 切片和切块

在数据立方体的某一维度上选定一个维成员的操作叫切片，而对两个或多个维执行选择则叫做切块。

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606192208.png)](https://static.studytime.xin/article/20200606192208.png)

```
# 切片
SELECT Locates.地区, Products.分类, SUM(数量)
FROM Sales, Dates, Products, Locates
WHERE Dates.季度 = 2
    AND Sales.Date_key = Dates.Date_key
    AND Sales.Locate_key = Locates.Locate_key
    AND Sales.Product_key = Products.Product_key
GROUP BY Locates.地区, Products.分类
 
# 切块
SELECT Locates.地区, Products.分类, SUM(数量)
FROM Sales, Dates, Products, Locates
WHERE (Dates.季度 = 2 OR Dates.季度 = 3) AND (Locates.地区 = '江苏' OR Locates.地区 = '上海')
    AND Sales.Date_key = Dates.Date_key
    AND Sales.Locate_key = Locates.Locate_key
    AND Sales.Product_key = Products.Product_key
GROUP BY Dates.季度, Locates.地区, Products.分类
```

#### 旋转(Pivot)

旋转就是指改变报表或页面的展示方向。对于使用者来说，就是个视图操作，而从SQL模拟语句的角度来说，就是改变SELECT后面字段的顺序而已。
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606192310.png)](https://static.studytime.xin/article/20200606192310.png)

#### 上卷和钻取(Rol-up and Drill-down)

上卷可以理解为”无视”某些维度；钻取则是指将某些维度进行细分。
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606192502.png)](https://static.studytime.xin/article/20200606192502.png)

```sql
# 上卷
SELECT Locates.地区, Products.分类, SUM(数量)
FROM Sales, Products, Locates
WHERE Sales.Locate_key = Locates.Locate_key
    AND Sales.Product_key = Products.Product_key
GROUP BY Locates.地区, Products.分类
 
# 钻取
SELECT Locates.地区, Dates.季度, Products.分类, SUM(数量)
FROM Sales, Dates, Products, Locates
WHERE Sales.Date_key = Dates.Date_key
    AND Sales.Locate_key = Locates.Locate_key
    AND Sales.Product_key = Products.Product_key
GROUP BY Dates.季度.月份, Locates.地区, Products.分类
```



# 浅谈数仓三、浅谈数仓分层和模型

### 数仓分层

#### ODS层基础层-ODS（Operational Data Store-操作型数据存储）：主要是未经过加⼯的原始数据

#### 中间层-CDM\EDW（Enterprise Data Warehouse-企业级数据仓库，Common Data Model，公共维度模型层）：

- dwd-明细整合层
- dws-⾼粒度汇总层，⼀般为主题宽表
- dim-维度表

#### 应⽤层-ADM（Application Data Mart-应⽤数据集市）：数据应⽤或数据集市所在的层次。

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606193853.png)](https://static.studytime.xin/article/20200606193853.png)

### 数仓分层意义

数仓为空间换时间，通过大量预处理，提升用户数据效率体现等。故而存在大量数据冗余。如果不分层，源业务系统的业务规则发生变化将会影响整个数据清洗过程，工作量巨大。
通过数据分层管理可以简化数据清洗的过程，因为把原来一步的工作分到了多个步骤去完成，相当于把一个复杂的工作拆成了多个简单的工作，把一个大的黑盒变成了一个白盒，每一层的处理逻辑都相对简单和容易理解，这样我们比较容易保证每一个步骤的正确性，当数据发生错误的时候，往往我们只需要局部调整某个步骤即可。

### 数仓建模

### 维度建模的基本概念

维度建模(dimensional modeling)是专门用于分析型数据库、数据仓库、数据集市建模的方法。

它本身属于一种关系建模方法，但和之前在操作型数据库中介绍的关系建模方法相比增加了两个概念：

#### 维度表(dimension)

表示对分析主题所属类型的描述。比如”昨天早上张三在京东花费200元购买了一个皮包”。那么以购买为主题进行分析，可从这段信息中提取三个维度：时间维度(昨天早上)，地点维度(京东), 商品维度(皮包)。通常来说维度表信息比较固定，且数据量小。

#### 事实表(fact table)

表示对分析主题的度量。比如上面那个例子中，200元就是事实信息。事实表包含了与各维度表相关联的外码，并通过JOIN方式与维度表关联。事实表的度量通常是数值类型，且记录数会不断增加，表规模迅速增长。

### 星形模式(Star Schema)

星形模式(Star Schema)是最常用的维度建模方式，下图展示了使用星形模式进行维度建模的关系结构：

[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606195353.png)](https://static.studytime.xin/article/20200606195353.png)

可以看出，星形模式的维度建模由一个事实表和一组维表成，且具有以下特点：
a. 维表只和事实表关联，维表之间没有关联；
b. 每个维表的主码为单列，且该主码放置在事实表中，作为两边连接的外码；
c. 以事实表为核心，维表围绕核心呈星形分布；

### 雪花模式

雪花模式(Snowflake Schema)是对星形模式的扩展，每个维表可继续向外连接多个子维表。下图为使用雪花模式进行维度建模的关系结构：
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606195422.png)](https://static.studytime.xin/article/20200606195422.png)

星形模式中的维表相对雪花模式来说要大，而且不满足规范化设计。雪花模型相当于将星形模式的大维表拆分成小维表，满足了规范化设计。然而这种模式在实际应用中很少见，因为这样做会导致开发难度增大，而数据冗余问题在数据仓库里并不严重。

### 星座模式

星座模式(Fact Constellations Schema)也是星型模式的扩展。基于这种思想就有了星座模式：
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606195506.png)](https://static.studytime.xin/article/20200606195506.png)

前面介绍的两种维度建模方法都是多维表对应单事实表，但在很多时候维度空间内的事实表不止一个，而一个维表也可能被多个事实表用到。在业务发展后期，绝大部分维度建模都采用的是星座模式。

### 三种模式对比

归纳一下，星形模式/雪花模式/星座模式的关系如下图所示：
[![img](02-%E6%B5%85%E8%B0%88%E6%95%B0%E4%BB%93.assets/20200606195544.png)](https://static.studytime.xin/article/20200606195544.png)

雪花模式是将星型模式的维表进一步划分，使各维表均满足规范化设计。而星座模式则是允许星形模式中出现多个事实表。